<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>GameInput Mapping Creator</title>
    <meta name="description" content="">
    <meta name="author" content="Samuel Sarette">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet"href="https://fonts.googleapis.com/css?family=Raleway:400,300,600">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.1.1/normalize.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
    <style>
        .container {
            max-width: 1920px;
        }
        .template {
            display: none !important;
        }
        .player:not(:last-child) {
            border-bottom: 2px dashed #ccc;
            padding-bottom: 4px;
            margin-bottom: 8px;
        }
        .player table {
            margin: 0;
        }
        .player th,
        .player td {
            padding: 6px 7px;
        }
        .player th:first-child,
        .player td:first-child,
        .player th:last-child,
        .player td:last-child {
            padding-left: 7px !important;
        }
        pre > code {
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div class="container">
    <div class="row">
      <div class="twelve columns" style="margin-top: 5%">
        <h1>GameInput Mapping Creator</h1>
      </div>
    </div>

    <div id="players" style="padding: 0; margin: 0;">
    </div>

    <div id="player-template" class="row template player">
      <div class="six columns">
        <table>
            <tr>
                <td rowspan="2">Basic</td>
                <td class="gamepad-id" colspan="2"></td>
            </tr>
            <tr>
                <td>
                    <img class="detected-icon gameinput-icon gameinput-icon-player-template" src="">
                </td>
                <td>
                    <select class="icon" onchange="updateIcon(this);">
                        <option value="generic">Generic</option>
                        <option value="nintendo-generic">Nintendo Generic</option>
                        <option value="sega-generic">SEGA Generic</option>
                        <option value="joystick">Generic Joystick</option>
                        <option value="ds3">DualShock 3</option>
                        <option value="ds4">DualShock 4</option>
                        <option value="dc">Dreamcast</option>
                        <option value="xbox360">Xbox 360</option>
                        <option value="xboxone">Xbox One</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td rowspan="4">D-Pad</td>
                <td>
                    <div class='gameinput-player-template-up gameinput-player-template-d_up gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="d_up" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-down gameinput-player-template-d_down gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="d_down" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-left gameinput-player-template-d_left gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="d_left" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-right gameinput-player-template-d_right gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="d_right" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td rowspan="9">
                    Buttons
                </td>
                <td>
                    <div class='gameinput-player-template-menu gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="menu" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-button0 gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="button0" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-button1 gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="button1" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-button2 gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="button2" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-button3 gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="button3" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-l_button gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="l_button" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-r_button gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="r_button" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-l_trigger gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="l_trigger" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-r_trigger gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="r_trigger" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td rowspan="4">Left Analog</td>
                <td>
                    <div class='gameinput-player-template-up gameinput-player-template-l_up gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="l_up" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-down gameinput-player-template-l_down gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="l_down" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-left gameinput-player-template-l_left gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="l_left" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-right gameinput-player-template-l_right gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="l_right" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td rowspan="4">Right Analog</td>
                <td>
                    <div class='gameinput-player-template-up gameinput-player-template-r_up gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="r_up" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-down gameinput-player-template-r_down gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="r_down" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-left gameinput-player-template-r_left gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="r_left" class="possible-mappings"></select> </td>
            </tr>
            <tr>
                <td>
                    <div class='gameinput-player-template-right gameinput-player-template-r_right gameinput-button'><span class='text'></span></div>
                </td>
                <td> <select onchange="updateMapping(this);" button="r_right" class="possible-mappings"></select> </td>
            </tr>
        </table>
      </div>
      <div class="six columns"><pre><code></code></pre></div>
   </div>

  </div>

<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
<script src="gameinput.js"></script>
<script src="gameinput.models.js"></script>
<script src="gameinput.custom.js"></script>
<script src="gameinput.dom.js"></script>
<script>
    "use strict";

    gi.debug = true;
    gi.handleKeyboard = false;
    gi.onReshufflePlayers(setupPlayers);
    gi.initialGamePadSetup();

    function setupPlayers()
    {
        document.querySelector("#players").innerHTML = '';

        for (var i = 0; i < gi.Players.length; i++)
        {
            if ( typeof(gi.getPlayer(i)) === "undefined"
            ||  typeof(gi.getPlayer(i).schema) === "undefined"
            ||   typeof(gi.getPlayer(i).type) === "undefined"
            ||   typeof(gi.Connection.Gamepads[gi.Connection.GamePadMapping[i]]) === "undefined"
            ||   gi.getPlayer(i).type === gi.Type.Keyboard) continue;

            var row = document.querySelector("#player-template").cloneNode(true);
            row.id = "";
            row.setAttribute("number", (i+1));
            row.classList.remove("template");

            var playerNumberReferences = row.querySelectorAll(".player-number");
            for (var k = 0; k < playerNumberReferences.length; k++) playerNumberReferences[k].textContent = (i+1);

            var iconPlayerReferences = row.querySelectorAll(".gameinput-icon-player-template");
            for (var k = 0; k < iconPlayerReferences.length; k++) {
                iconPlayerReferences[k].classList.add("gameinput-icon-player" + i);
                iconPlayerReferences[k].classList.remove("gameinput-icon-player-template");
            }

            var gamepadIDReferences = row.querySelectorAll(".gamepad-id");
            for (var k = 0; k < gamepadIDReferences.length; k++) {
                gamepadIDReferences[k].textContent = gi.Connection.Gamepads[gi.Connection.GamePadMapping[i]].id;
            }

            var iconSelectorReferences = row.querySelectorAll("select.icon");
            for (var k = 0; k < iconSelectorReferences.length; k++) {
                iconSelectorReferences[k].value = gi.getPlayer(i).model.iconName;
            }

            for (var j in gi.Schema.Names)
            {
                var templateUpReferences = row.querySelectorAll(".gameinput-player-template-up");
                for (var k = 0; k < templateUpReferences.length; k++) {
                    templateUpReferences[k].classList.add("gameinput-player" + i + "-up");
                    templateUpReferences[k].classList.remove("gameinput-player-template-up");
                }
                var templateDownReferences = row.querySelectorAll(".gameinput-player-template-down");
                for (var k = 0; k < templateDownReferences.length; k++) {
                    templateDownReferences[k].classList.add("gameinput-player" + i + "-down");
                    templateDownReferences[k].classList.remove("gameinput-player-template-down");
                }
                var templateLeftReferences = row.querySelectorAll(".gameinput-player-template-left");
                for (var k = 0; k < templateLeftReferences.length; k++) {
                    templateLeftReferences[k].classList.add("gameinput-player" + i + "-left");
                    templateLeftReferences[k].classList.remove("gameinput-player-template-left");
                }
                var templateRightReferences = row.querySelectorAll(".gameinput-player-template-right");
                for (var k = 0; k < templateRightReferences.length; k++) {
                    templateRightReferences[k].classList.add("gameinput-player" + i + "-right");
                    templateRightReferences[k].classList.remove("gameinput-player-template-right");
                }

                var templateReferences = row.querySelectorAll(".gameinput-player-template-" + gi.Schema.Names[j]);
                for (var k = 0; k < templateReferences.length; k++) {
                    templateReferences[k].classList.add("gameinput-player" + i + "-" + gi.Schema.Names[j]);
                    templateReferences[k].classList.remove("gameinput-player-template-" + gi.Schema.Names[j]);
                }

                updateSelection(row, i, j);
            }

            document.body.querySelector("#players").appendChild(row);
            updateCode(row.children[i]);
        }
    }

    function updateSelection(row, playerIndex, schemaName)
    {
        var optionsHTML = "";
        var index = playerIndex;
        var player = playerIndex +1;

        var isUndefined = false;
        var currentAxis;
        var currentButton = gi.getPlayer(index).schema[schemaName];

        if (typeof(currentButton) === "undefined")
        {
            isUndefined = true;
        }
        else if (isNaN(currentButton))
        {
            currentAxis = currentButton.index * (currentButton.direction === "positive" ? 1 : -1 );
            currentButton = undefined;
        }

        optionsHTML += "<option value='undefined' " + (isUndefined ? "selected" : "") + " type='undefined'>Not Mapped</option>";

        for (var i = 1; i <= gi.Connection.Gamepads[gi.Connection.GamePadMapping[index]].axes.length; i++)
        {
            optionsHTML += "<option value='" + i + "' " + (currentAxis == i ? "selected" : "" ) + " type='axis'>+ " + i  + " axis</option>";
            optionsHTML += "<option value='-" + i + "' " + (currentAxis == -1*i ? "selected" : "") + " type='axis'>- " + i  + " axis</option>";
        }

        for (var i = 1; i <= gi.Connection.Gamepads[gi.Connection.GamePadMapping[index]].buttons.length; i++)
        {
            optionsHTML += "<option value='" + i + "' " + (currentButton == i ? "selected" : "") + " type='button'>" + i  + " button</option>";
        }

        var buttonReferences = row.querySelectorAll(".possible-mappings[button=" + schemaName + "]");
        for (var k = 0; k < buttonReferences.length; k++) buttonReferences[k].innerHTML = optionsHTML;
    }

    function updateMapping(element) {
        var playerElement = findAncestor(element, "player");
        var player = playerElement.getAttribute("number");
        var index = player - 1;

        var type = element[element.selectedIndex].getAttribute("type");
        var schemaName = element.getAttribute("button");
        var value = parseInt(element.value);

        if (type == "button")
        {
            gi.getPlayer(index).model.schema[schemaName] = value;
            gi.getPlayer(index).schema[schemaName] = value;
        }
        else //if (type == "axis")
        {
            gi.getPlayer(index).model.schema[schemaName] = new gi.Schema.AxisButton(value);
            gi.getPlayer(index).schema[schemaName] = new gi.Schema.AxisButton(value);
        }
        updateCode(element);
    }

    function updateIcon(element) {
        var playerElement = findAncestor(element, "player");
        var player = playerElement.getAttribute("number");
        var index = player - 1;
        var icon = playerElement.querySelector("select.icon").value;

        var detectedIconReferences = playerElement.querySelectorAll(".detected-icon");
        for (var k = 0; k < detectedIconReferences.length; k++ ) {
            detectedIconReferences[k].src = "img/" + icon + ".png";
        }

        updateCode(element);
    }

    function updateCode(element)
    {
        var playerElement = findAncestor(element, "player");
        var player = playerElement.getAttribute("number");
        var index = player - 1;

        if (gi.getPlayer(index).type == gi.Type.Keyboard)
        {
            console.warn("Player is Keyboard user.");
            return;
        }
        var icon = playerElement.querySelector("select.icon").value;
        var theme = "";

        switch (icon) {
            case "ds2":
            case "ds3":
                changeGamepadType(index, gi.Type.Ragdoll);
                theme = "gi.Type.Ragdoll";
                break;
            case "ds4":
                changeGamepadType(index, gi.Type.Ragdoll4);
                theme = "gi.Type.Ragdoll4";
                break;
            case "nintendo-generic":
            case "snes":
                changeGamepadType(index, gi.Type.Plumber);
                theme = "gi.Type.Plumber";
                break;
            case "sega-generic":
            case "dc":
            case "xbox360":
            case "xboxone":
            default:
                changeGamepadType(index, gi.Type.Hedgehog);
                theme = "gi.Type.Hedgehog";
                break;
        }

        var newCode = 'new gi.Model(\n\t' + theme + ',\n\t"' + icon + '",\n\t"' + gi.Connection.Gamepads[index].id + '",\n\t"' + gi.os + '",\n\tnew gi.Schema.GamePadAPI(\n';

        for (var schemaName in gi.Schema.Names)
        {
            var item = gi.getPlayer(index).schema[schemaName];

            if (typeof(item) !== "undefined"
                && isNaN(item.index)  === false
                && typeof(item.direction) !== "undefined")
            {
                if (item instanceof gi.Schema.AxisButton) {
                    item = "new gi.Schema.AxisButton(" + ( item.index * (item.direction === "positive" ? 1 : -1 )) + ")";
                } else {
                    item = "undefined";
                }
            } else if (isNaN(item)) {
                item = "undefined";
            }

            newCode += "\t\t/* " + schemaName + " */  " + item + ",\n";
        }
        newCode = newCode.slice(0, newCode.length - 2); // take off the last comma and newline

        newCode += '\n\t)\n),';

        playerElement.querySelector("code").textContent = newCode;
    }

    function changeGamepadType(playerIndex, type)
    {
        var player = gi.getPlayer(playerIndex);
        player.type = type;

        var previousThemeStyleElements = document.head.querySelectorAll('.gameinput-theme-player' + player.index);
        for (var j = 0; j < previousThemeStyleElements.length; j++) document.head.removeChild(previousThemeStyleElements[j]);

        var themeStyleElement = document.createElement('link');
        themeStyleElement.classList.add("gameinput-theme-player" + player.index);
        themeStyleElement.setAttribute("rel", "stylesheet");
        themeStyleElement.setAttribute("href", "css/" + player.type.theme.name.toLowerCase() + "/" + player.index + ".css");
        document.head.appendChild(themeStyleElement);
    }

    function findAncestor (el, cls) {
        if (typeof(el.closest)) return el.closest("." + cls);

        while ((el = el.parentElement) && !el.classList.contains(cls));
        return el;
    }

</script>
</body>
</html>
